<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App for GitHub Pages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <style>
      /* Custom CSS */
      body {
        font-family: "Inter", sans-serif;
      }
      #chat-window {
        height: calc(
          100vh - 200px
        ); /* Ensure the chat window has a reasonable height */
        scroll-behavior: smooth;
      }
      /* Custom scrollbar for a better look */
      #chat-window::-webkit-scrollbar {
        width: 8px;
      }
      #chat-window::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      #chat-window::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      #chat-window::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .message-bubble {
        max-width: 75%;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div
      class="w-full max-w-2xl mx-4 bg-white rounded-2xl shadow-2xl flex flex-col"
      style="height: 90vh">
      <!-- Header -->
      <div
        class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-800">Public Chat Room</h1>
        <div id="status" class="flex items-center space-x-2">
          <span class="text-sm font-medium text-gray-500">Connecting...</span>
          <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
        </div>
      </div>

      <!-- Chat Window -->
      <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4">
        <!-- Messages will be added here by JS -->
      </div>

      <!-- Input Area -->
      <div class="p-4 bg-gray-50 border-t border-gray-200">
        <div class="flex items-center space-x-3">
          <input
            type="text"
            id="username"
            placeholder="Enter your name"
            class="w-1/4 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" />
          <input
            type="text"
            id="message-box"
            placeholder="Type a message..."
            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
            disabled />
          <button
            id="send-button"
            class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
            disabled>
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- Configuration ---
        // Using a free public WebSocket service.
        const WEBSOCKET_URL =
          "wss://demo.piesocket.com/v3/channel_1?api_key=VCXCEuvhGcBDP7XhiJJUDvR1e1D3eiVjgZ9VRiaV&notify_self";

        // --- Get DOM Elements ---
        const chatWindow = document.getElementById("chat-window");
        const messageBox = document.getElementById("message-box");
        const sendButton = document.getElementById("send-button");
        const usernameInput = document.getElementById("username");
        const statusIndicator = document.getElementById("status");

        let myUsername = `User-${Math.floor(Math.random() * 1000)}`;
        usernameInput.value = myUsername;

        // --- Initialize WebSocket ---
        console.log(`Connecting to ${WEBSOCKET_URL}...`);
        const socket = new WebSocket(WEBSOCKET_URL);

        const updateStatus = (text, color, isPulsing) => {
          statusIndicator.innerHTML = `
                    <span class="text-sm font-medium text-gray-500">${text}</span>
                    <div class="w-3 h-3 bg-${color}-500 rounded-full ${
            isPulsing ? "animate-pulse" : ""
          }"></div>
                `;
        };

        // --- WebSocket Event Handlers ---

        // 1. On successful connection
        socket.onopen = () => {
          console.log("WebSocket connection established!");
          updateStatus("Connected", "green", false);
          messageBox.disabled = false;
          sendButton.disabled = false;
          messageBox.focus();

          addSystemMessage(
            "Welcome! This is a public chat room. All messages are visible to everyone."
          );
        };

        // 2. On receiving a message from the server
        socket.onmessage = (event) => {
          console.log("Received message:", event.data);
          try {
            const rawData = event.data;
            let messageData;

            try {
              messageData = JSON.parse(rawData);
            } catch (e) {
              // If it can't be parsed, treat it as a system message or from a client not using JSON
              messageData = {
                username: "Stranger",
                message: rawData,
                type: "other",
              };
            }

            if (messageData.username && messageData.message) {
              addChatMessage(messageData.username, messageData.message);
            }
          } catch (error) {
            console.error("Error processing message:", error);
            // Display the raw message if parsing fails
            addChatMessage("System", event.data);
          }
        };

        // 3. On connection close
        socket.onclose = () => {
          console.warn("WebSocket connection closed.");
          updateStatus("Disconnected", "red", false);
          messageBox.disabled = true;
          sendButton.disabled = true;
          addSystemMessage(
            "You have been disconnected. Please refresh the page to reconnect."
          );
        };

        // 4. On connection error
        socket.onerror = (error) => {
          console.error("WebSocket error:", error);
          updateStatus("Connection Error", "red", false);
          addSystemMessage("A connection error occurred with the chat server.");
        };

        // --- Helper Functions ---

        const sendMessage = () => {
          const message = messageBox.value.trim();
          const username = usernameInput.value.trim();

          if (!username) {
            alert("Please enter your name!");
            usernameInput.focus();
            return;
          }

          if (message && socket.readyState === WebSocket.OPEN) {
            myUsername = username; // Update username

            const dataToSend = {
              username: myUsername,
              message: message,
            };

            // Send data as a JSON string
            socket.send(JSON.stringify(dataToSend));

            // The 'notify_self' parameter in the URL makes the server send our own message back to us,
            // so we don't need to add it to the chat window manually.

            messageBox.value = "";
            messageBox.focus();
          }
        };

        const addChatMessage = (user, message, isMe = false) => {
          // Check if the sender is the current user
          const fromMe = user === myUsername || isMe;

          const messageElement = document.createElement("div");
          messageElement.classList.add(
            "flex",
            "flex-col",
            fromMe ? "items-end" : "items-start"
          );

          messageElement.innerHTML = `
                    <span class="text-xs text-gray-500 mb-1">${
                      fromMe ? "You" : user
                    }</span>
                    <div class="message-bubble p-3 rounded-2xl ${
                      fromMe
                        ? "bg-blue-600 text-white rounded-br-lg"
                        : "bg-gray-200 text-gray-800 rounded-bl-lg"
                    }">
                        ${escapeHTML(message)}
                    </div>
                `;
          chatWindow.appendChild(messageElement);
          chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to the bottom
        };

        const addSystemMessage = (message) => {
          const messageElement = document.createElement("div");
          messageElement.classList.add("text-center", "my-2");
          messageElement.innerHTML = `<span class="text-sm text-gray-500 italic px-2 py-1 bg-gray-100 rounded-full">${escapeHTML(
            message
          )}</span>`;
          chatWindow.appendChild(messageElement);
          chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        // Function to prevent XSS attacks
        const escapeHTML = (str) => {
          const p = document.createElement("p");
          p.appendChild(document.createTextNode(str));
          return p.innerHTML;
        };

        // --- Attach Event Listeners ---
        sendButton.addEventListener("click", sendMessage);
        messageBox.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault(); // Prevents new line on enter
            sendMessage();
          }
        });
        usernameInput.addEventListener("change", (event) => {
          myUsername =
            event.target.value.trim() ||
            `User-${Math.floor(Math.random() * 1000)}`;
        });
      });
    </script>
  </body>
</html>
