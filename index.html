<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App - GitHub Pages Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <!-- Thư viện client của Socket.IO không cần thay đổi -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      #chat-window {
        height: calc(100vh - 200px);
        scroll-behavior: smooth;
      }
      #chat-window::-webkit-scrollbar {
        width: 8px;
      }
      #chat-window::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      #chat-window::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      #chat-window::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .message-bubble {
        max-width: 75%;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div
      class="w-full max-w-2xl mx-4 bg-white rounded-2xl shadow-2xl flex flex-col"
      style="height: 90vh">
      <!-- Header -->
      <div
        class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h1 class="text-xl font-bold text-gray-800">Public Chat Room</h1>
        <div id="status" class="flex items-center space-x-2">
          <span class="text-sm font-medium text-gray-500">Connecting...</span>
          <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
        </div>
      </div>

      <!-- Chat Window -->
      <div id="chat-window" class="flex-1 p-4 overflow-y-auto space-y-4">
        <!-- Messages will be added here by JS -->
      </div>

      <!-- Input Area -->
      <div class="p-4 bg-gray-50 border-t border-gray-200">
        <div class="flex items-center space-x-3">
          <input
            type="text"
            id="username"
            placeholder="Enter your name"
            class="w-1/4 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" />
          <input
            type="text"
            id="message-box"
            placeholder="Type a message..."
            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
            disabled />
          <button
            id="send-button"
            class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
            disabled>
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- Get DOM Elements ---
        const chatWindow = document.getElementById("chat-window");
        const messageBox = document.getElementById("message-box");
        const sendButton = document.getElementById("send-button");
        const usernameInput = document.getElementById("username");
        const statusIndicator = document.getElementById("status");

        let myUsername = `User-${Math.floor(Math.random() * 1000)}`;
        usernameInput.value = myUsername;

        const SERVER_URL = "https://chatapp-socketio-mr7l.onrender.com/";
        console.log(`Connecting to remote server at ${SERVER_URL}...`);
        const socket = io(SERVER_URL);

        const updateStatus = (text, color, isPulsing) => {
          statusIndicator.innerHTML = `
                        <span class="text-sm font-medium text-gray-500">${text}</span>
                        <div class="w-3 h-3 bg-${color}-500 rounded-full ${
            isPulsing ? "animate-pulse" : ""
          }"></div>
                    `;
        };

        socket.on("connect", () => {
          console.log("Socket.IO connection established!");
          updateStatus("Connected", "green", false);
          messageBox.disabled = false;
          sendButton.disabled = false;
          messageBox.focus();
          addSystemMessage("Welcome! You are connected to the chat.");
        });

        socket.on("chat message", (messageData) => {
          console.log("Received message:", messageData);
          if (messageData.username && messageData.message) {
            addChatMessage(messageData.username, messageData.message);
          }
        });

        socket.on("disconnect", () => {
          console.warn("Socket.IO connection closed.");
          updateStatus("Disconnected", "red", false);
          messageBox.disabled = true;
          sendButton.disabled = true;
          addSystemMessage(
            "You have been disconnected. Please refresh the page to reconnect."
          );
        });

        socket.on("connect_error", (error) => {
          console.error("Socket.IO connection error:", error);
          updateStatus("Connection Error", "red", false);
          addSystemMessage("A connection error occurred with the chat server.");
        });

        const sendMessage = () => {
          const message = messageBox.value.trim();
          const username = usernameInput.value.trim();

          if (!username) {
            addSystemMessage("Please enter your name!");
            usernameInput.focus();
            return;
          }

          if (message && socket.connected) {
            myUsername = username;

            const dataToSend = {
              username: myUsername,
              message: message,
            };

            socket.emit("chat message", dataToSend);
            messageBox.value = "";
            messageBox.focus();
          }
        };

        const addChatMessage = (user, message) => {
          const fromMe = user === myUsername;
          const messageElement = document.createElement("div");
          messageElement.classList.add(
            "flex",
            "flex-col",
            fromMe ? "items-end" : "items-start"
          );
          messageElement.innerHTML = `
                        <span class="text-xs text-gray-500 mb-1">${
                          fromMe ? "You" : user
                        }</span>
                        <div class="message-bubble p-3 rounded-2xl ${
                          fromMe
                            ? "bg-blue-600 text-white rounded-br-lg"
                            : "bg-gray-200 text-gray-800 rounded-bl-lg"
                        }">
                            ${escapeHTML(message)}
                        </div>
                    `;
          chatWindow.appendChild(messageElement);
          chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        const addSystemMessage = (message) => {
          const messageElement = document.createElement("div");
          messageElement.classList.add("text-center", "my-2");
          messageElement.innerHTML = `<span class="text-sm text-gray-500 italic px-2 py-1 bg-gray-100 rounded-full">${escapeHTML(
            message
          )}</span>`;
          chatWindow.appendChild(messageElement);
          chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        const escapeHTML = (str) => {
          const p = document.createElement("p");
          p.appendChild(document.createTextNode(str));
          return p.innerHTML;
        };

        sendButton.addEventListener("click", sendMessage);
        messageBox.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
          }
        });
        usernameInput.addEventListener("change", (event) => {
          myUsername =
            event.target.value.trim() ||
            `User-${Math.floor(Math.random() * 1000)}`;
        });
      });
    </script>
  </body>
</html>
